<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>2020 April 27 :: Path Rendering Anti-Aliasing - msiglreith blog</title>
        

        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800" rel="stylesheet" type="text/css">
        <link href="https://fonts.googleapis.com/css?family=Source+Code+Pro:500" rel="stylesheet" type="text/css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        

        
        <!-- MathJax -->
        <script async type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
        
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="path_aa.html" class="active">2020 April 27 :: Path Rendering Anti-Aliasing</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                        
                    </div>

                    <h1 class="menu-title">msiglreith blog</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        
                    </div>
                </div>

                
                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" name="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1><a class="header" href="#path-rendering-anti-aliasing" id="path-rendering-anti-aliasing">Path Rendering Anti-Aliasing</a></h1>
<h5><a class="header" href="#2020-april-27" id="2020-april-27">2020 April 27</a></h5>
<p>Recently, there have been a bunch of new GPU based path renderer using different approaches for achieving real-time framerates with just a few of them mentioned here:</p>
<ul>
<li><a href="http://kunzhou.net/zjugaps/pathrendering/">Li et al. 2016</a> computes winding numbers via raycasting and ports the classic scanline rasterization over to the GPU</li>
<li><a href="http://jcgt.org/published/0006/02/02/">Eric Lengyel</a> showed in their paper how to combine raycasts with clever optimizations, which is the core of their commercial slug library.</li>
<li>Raph Levien demonstrated a compute based architecture for a signed distance based approach with <a href="https://raphlinus.github.io/rust/graphics/gpu/2019/05/08/modern-2d.html">piet-metal</a> and the successor is already in the pipeline.</li>
<li>Patrick Walton developed their <a href="https://github.com/servo/pathfinder">Pathfinder</a> library using CPU tiling approach, which has been released to crates.io recently!</li>
</ul>
<h2><a class="header" href="#overview" id="overview">Overview</a></h2>
<p>In this post I want to explore one specific part of the path rendering process: Anti-Aliasing!
Aliasing appears as result of the rasterization process when presenting curves onto a 'low resolution' screen. It can be seen as jagged edges, which could be smoothed by simply increasing the sampling rate for the cost of increasing the frametimes. For simplicity, we just focus on greyscale for now and reduce the issue to what greyscale value should be assigned to each pixel on the screen imaging rendering black text onto a white screen. The text is encoded as bezier curves where we will further just look at linear and quadratic curves.</p>
<p><a href="http://faculty.cs.tamu.edu/schaefer/research/scanline.pdf">Manson and Schaefer 2013</a> researched how to achieve high quality rendering using an analytic approach by employing convolution with separable filters. We will basically take this as gold standard as polynomial are closed under all the needed operations and we end up with polynomials as closed formula, nice! Unfortunately it's computationally expensive when looking at higher order filters due to function composition, even simple tent filters for quadratic curves already suffer from it.</p>
<h2><a class="header" href="#approximate-aa-for-1d-raycasting" id="approximate-aa-for-1d-raycasting">Approximate AA for 1D Raycasting</a></h2>
<p>For our renderer we are using raycasts as in the first two papers listed. Initially, we went with the classic trapezoid approximation as used in Pathfinder, by casting two vertical and horizontal rays for each pixel to calculate intersection points. Using the separable convolution filter framework this would be calculated by using 1D box filter in x and y direction, but approximating quadratics. In comparison, the &quot;GPU-Centered Font Rendering Directly from Glyph Outlines&quot; paper (2nd in the list) uses two independent raycast (vertical &amp; horizontal) with 1D box filtering with the option for supersampling by averaging the coverage values.</p>
<p>It turned out that the trapezoid approach with raycasts on the GPU in our implementation suffered from floating point errors, so back to the drawing board!
Motivated by the great work of <a href="https://github.com/glowcoil">@glowcoil</a> in their <code>gouache</code> path renderer, who managed to achieve good anti aliasing even with only a single(!) ray, I looked more into this direction.</p>
<p><img src="images/path_box_issue.png" alt="Path Visualization" />
Let's analyze the issue again in detail using the figure above. The red area denotes the coverage of the pixel for the red curve. We can either raycast vertically of horizontally from the sample point in the center of the pixel. In both cases the distance would be around 0. Using a simple 1D box filter would yield around 50% coverage which looks plausible</p>
<pre><pre class="playpen"><code class="language-rust">
<span class="boring">#![allow(unused_variables)]
</span><span class="boring">fn main() {
</span>fn box_filter(distance: f32) -&gt; f32 {
    clamp(distance + 0.5, 0.0, 1.0)
}
<span class="boring">}
</span></code></pre></pre>
<p>If we look at the pixel at left tho the story is totally different! A raycast in y-direction would yield reasonable results but in x-direction it would be around 0% as the distance would be over 0.5. To improve this we are incorporating the curve tangent on the ray intersection point, which gives an approximation of the trapezoid area coverage. See https://www.desmos.com/calculator/hg7j076glf for a plot of the where we can control the slope <code>m</code>. The green curve is the integral of the red curve which directly denotes the coverage area we are looking for. The figure <code>Exact intergral</code> shows the results when applying this approximation using the integral:</p>
<pre><pre class="playpen"><code class="language-rust">
<span class="boring">#![allow(unused_variables)]
</span><span class="boring">fn main() {
</span>fn intergral(d: f32, m: f32) -&gt; f32 {
    let bound = -0.5 * m;
    let upper = clamp(d + 0.5, -bound, bound);
    let lower = clamp(d - 0.5, -bound, upper);
    let linear = clamp(lower - d + 0.5, 0.0, 1.0);
    let quadratic = 0.5 * (upper - lower + (upper * upper - lower * lower) / m);
    linear + quadratic
}
<span class="boring">}
</span></code></pre></pre>
<table><thead><tr><th align="center">1D Box Filtering</th><th align="center">Our Integral approximation</th><th align="center">Exact integral</th></tr></thead><tbody>
<tr><td align="center"><img src="images/path_approx_01.png" alt="" /></td><td align="center"><img src="images/path_approx_02.png" alt="" /></td><td align="center"><img src="images/path_approx_03.png" alt="" /></td></tr>
</tbody></table>
<p>Quality-wise the results are promising, from a computational aspect there is still room for improvement (:
Looking at the integral curve in the plot, we can see its behavior when the slope converges to <code>0</code> and <code>inf</code>:</p>
<p><img src="images/plot_0_5.png" alt="Slope 0.3" />
<img src="images/plot_3.png" alt="Slope 3.0" /></p>
<p>For the <code>m = inf</code> case we see that the difference between the red and the green curve becomes negligible, so this would be a good approximation:
We need to further tweak it to handle the <code>m = 0</code> case by clamping the slope of our curve to not be smaller than 1.
And with a bit of optimization we end up with our approximation:</p>
<pre><pre class="playpen"><code class="language-rust">
<span class="boring">#![allow(unused_variables)]
</span><span class="boring">fn main() {
</span>fn approx_aa(d: f32, tangent: f32x2) -&gt; f32 {
    // Ignore signs as the problem is symmetric
    let tangent = abs(tangent);
    // `max` operation keeps the **inverse** slope &lt;= 1
    let inv_m = tangent.x / max(tangent.x, tangent.y);
    clamp(d * inv_m + 0.5, 0.0, 1.0)
}
<span class="boring">}
</span></code></pre></pre>
<h3><a class="header" href="#conclusion" id="conclusion">Conclusion</a></h3>
<p>The <code>Our Integral approximation</code> figure shows that the approximation looks reasonable, it shows small differences to the <code>Exact integral</code> figure if you squint at the cases where the slope is around 1 as this is the place where our approximation has the larger numerical error.
As we target GPUs let's quickly discuss performance compared to the 1D box filter for the GCN architecture as reference:</p>
<ul>
<li><code>abs</code> and <code>clamp</code> operations are basically free on this architecture (operator modifier)</li>
<li><code>max</code>, <code>mul</code> run on full-rate and <code>rcp</code> (div) on quarter-rate -&gt; (1 + 1 + 4) * 4 cycles overhead</li>
</ul>
<p>Overall I'm quite happy with the results even with this very crude approximation for only minimal performance overhead.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                        

                        

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                

                
            </nav>

        </div>

        

        

        
        
        
        <script type="text/javascript">
            window.playpen_copyable = true;
        </script>
        

        

        
        <script src="elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="searcher.js" type="text/javascript" charset="utf-8"></script>
        

        <script src="clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        

        

    </body>
</html>
